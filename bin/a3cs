#!/usr/bin/perl -w

=head1 NAME

a3cs - A3 cluster sync

=head1 SYNOPSIS

Synchronizes across all the nodes in the cluster

=cut

use warnings;
use strict;

use lib '/usr/local/pf/lib';

use pf::log;
use pf::cluster;

BEGIN {
    #Ensure that the file permissions of the log file is correct 0660
    umask (0);
    use pf::log (service => 'a3cs');
}

our $PROGRAM_NAME = $0 = 'a3cs';

my $logger = get_logger( $PROGRAM_NAME );

if ( !$pf::cluster::cluster_enabled ) {
    $logger->info("Not syncing since cluster is disabled");
    exit 0;
}

if (pf::cluster::is_management()) {
    $logger->info("syncing as master on the master node only");

    system("/usr/local/pf/bin/cluster/sync --as-master");
}

#check files that have been removed
my $target_dir = "/usr/local/pf/conf/ssl/tls_certs/";
pf::cluster::sync_and_remove_cluster_file($target_dir);
